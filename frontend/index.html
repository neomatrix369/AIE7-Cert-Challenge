<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Student Loan Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-content {
            white-space: pre-wrap;
        }
        .loading-dots {
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dots:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <h1 class="text-xl font-semibold">Federal Student Loan Assistant</h1>
            </div>
            <div class="flex items-center space-x-2">
                <div id="apiStatus" class="flex items-center space-x-1 text-gray-200">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm">Checking...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Messages -->
    <div class="flex-1 max-w-4xl mx-auto w-full p-4">
        <div id="messagesContainer" class="space-y-4 mb-4">
            <!-- Initial welcome message -->
            <div class="flex justify-start">
                <div class="bg-white text-gray-800 shadow-md border rounded-lg p-4 max-w-3xl">
                    <div class="message-content">Hello! I'm your Federal Student Loan Assistant. I can help answer questions about federal student loan policies, procedures, and common issues. What would you like to know?</div>
                    <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                        <span id="welcomeTime"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="border-t bg-white p-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex space-x-4">
                <textarea
                    id="messageInput"
                    placeholder="Ask me anything about federal student loans..."
                    class="flex-1 border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                    rows="2"
                ></textarea>
                <button
                    id="sendButton"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                >
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <span>Send</span>
                </button>
            </div>
            <div class="mt-2 text-xs text-gray-500">
                Press Enter to send, Shift+Enter for new line
            </div>
        </div>
    </div>

    <script>
        // Enhanced Console Logging System
        const logger = {
            levels: {
                DEBUG: 0,
                INFO: 1,
                WARN: 2,
                ERROR: 3
            },
            currentLevel: 1, // Default to INFO level
            
            log(level, category, message, data = null) {
                if (this.levels[level] < this.currentLevel) return;
                
                const timestamp = new Date().toISOString();
                const prefix = `[${timestamp}] [${level}] [${category}]`;
                
                switch (level) {
                    case 'DEBUG':
                        console.debug(`🔍 ${prefix}`, message, data || '');
                        break;
                    case 'INFO':
                        console.info(`ℹ️ ${prefix}`, message, data || '');
                        break;
                    case 'WARN':
                        console.warn(`⚠️ ${prefix}`, message, data || '');
                        break;
                    case 'ERROR':
                        console.error(`❌ ${prefix}`, message, data || '');
                        break;
                }
            },
            
            debug(category, message, data) { this.log('DEBUG', category, message, data); },
            info(category, message, data) { this.log('INFO', category, message, data); },
            warn(category, message, data) { this.log('WARN', category, message, data); },
            error(category, message, data) { this.log('ERROR', category, message, data); },
            
            setLevel(level) {
                this.currentLevel = this.levels[level];
                this.info('LOGGER', `Log level set to ${level}`);
            }
        };

        // Enhanced Application State Management
        const appState = {
            // Core state
            isLoading: false,
            apiStatus: 'unknown',
            backendUrl: 'http://localhost:8000',
            error: null,
            
            // Message management
            messages: [],
            messageIdCounter: 0,
            
            // UI state
            lastScrollPosition: 0,
            autoScroll: true,
            
            // Performance tracking
            lastRequestTime: null,
            averageResponseTime: 0,
            requestCount: 0,

            // State update methods
            setState(updates) {
                const oldState = { ...this };
                Object.assign(this, updates);
                logger.debug('STATE', 'State updated', { 
                    old: oldState, 
                    new: { ...this },
                    changes: updates 
                });
                this.notifyStateChange(updates);
            },

            setLoading(loading, context = '') {
                this.setState({ isLoading: loading });
                logger.info('UI', `Loading state: ${loading}`, { context });
            },

            setError(error, context = '') {
                this.setState({ error });
                if (error) {
                    logger.error('STATE', `Error set: ${error}`, { context });
                } else {
                    logger.info('STATE', 'Error cleared', { context });
                }
            },

            addMessage(message) {
                const messageWithId = {
                    id: ++this.messageIdCounter,
                    timestamp: new Date(),
                    ...message
                };
                this.messages.push(messageWithId);
                logger.info('CHAT', `Message added: ${message.isUser ? 'USER' : 'BOT'}`, {
                    messageId: messageWithId.id,
                    contentLength: message.content.length,
                    metadata: message.metadata
                });
                this.notifyStateChange({ messages: this.messages });
                return messageWithId;
            },

            updatePerformanceMetrics(responseTime) {
                this.requestCount++;
                this.averageResponseTime = ((this.averageResponseTime * (this.requestCount - 1)) + responseTime) / this.requestCount;
                logger.info('PERFORMANCE', `Request completed`, {
                    responseTime: `${responseTime}ms`,
                    averageResponseTime: `${this.averageResponseTime.toFixed(2)}ms`,
                    totalRequests: this.requestCount
                });
            },

            notifyStateChange(changes) {
                // Hook for future state change listeners
                if (changes.messages && this.autoScroll) {
                    requestAnimationFrame(() => scrollToBottom());
                }
            }
        };

        // Auto-detect backend URL in Docker environment
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            appState.setState({ backendUrl: 'http://rag-api:8000' });
            logger.info('CONFIG', 'Docker environment detected, using service name for backend');
        }

        // DOM elements with enhanced references
        const domElements = {
            messagesContainer: null,
            messageInput: null,
            sendButton: null,
            apiStatusElement: null,
            welcomeTimeElement: null,
            messagesEndRef: null, // Virtual ref for auto-scrolling
            
            init() {
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.apiStatusElement = document.getElementById('apiStatus');
                this.welcomeTimeElement = document.getElementById('welcomeTime');
                
                // Create virtual scroll target
                this.messagesEndRef = document.createElement('div');
                this.messagesEndRef.id = 'messages-end-ref';
                this.messagesContainer.appendChild(this.messagesEndRef);
                
                logger.info('DOM', 'DOM elements initialized successfully');
            }
        };

        // Enhanced scroll management
        function scrollToBottom(behavior = 'smooth') {
            try {
                if (domElements.messagesEndRef && appState.autoScroll) {
                    domElements.messagesEndRef.scrollIntoView({ 
                        behavior,
                        block: 'end'
                    });
                    logger.debug('UI', 'Scrolled to bottom', { behavior });
                }
            } catch (error) {
                logger.warn('UI', 'Failed to scroll to bottom', error);
            }
        }

        // Handle scroll events to manage auto-scroll behavior
        function handleScroll() {
            const container = domElements.messagesContainer;
            const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
            
            if (appState.autoScroll !== isNearBottom) {
                appState.setState({ autoScroll: isNearBottom });
                logger.debug('UI', `Auto-scroll ${isNearBottom ? 'enabled' : 'disabled'}`);
            }
        }

        // Initialize application
        function initializeApp() {
            logger.info('APP', 'Initializing Federal Student Loan Assistant Frontend');
            
            // Initialize DOM elements
            domElements.init();
            
            // Set welcome message time
            domElements.welcomeTimeElement.textContent = new Date().toLocaleTimeString();
            
            // Add scroll listener for auto-scroll management
            domElements.messagesContainer.addEventListener('scroll', handleScroll);
            
            // Check API health on page load
            checkApiHealth();
            
            logger.info('APP', 'Application initialized successfully');
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Enhanced event listeners with error handling
        function setupEventListeners() {
            try {
                domElements.sendButton.addEventListener('click', sendMessage);
                domElements.messageInput.addEventListener('keydown', handleKeyPress);
                logger.info('EVENTS', 'Event listeners setup successfully');
            } catch (error) {
                logger.error('EVENTS', 'Failed to setup event listeners', error);
            }
        }

        function handleKeyPress(event) {
            logger.debug('INPUT', `Key pressed: ${event.key}`, { 
                shiftKey: event.shiftKey, 
                inputLength: domElements.messageInput.value.length 
            });
            
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function checkApiHealth() {
            logger.info('API', 'Checking backend API health', { url: appState.backendUrl });
            
            try {
                const startTime = performance.now();
                const response = await fetch(`${appState.backendUrl}/health`);
                const responseTime = performance.now() - startTime;
                
                logger.info('API', `Health check response received`, { 
                    status: response.status, 
                    responseTime: `${responseTime.toFixed(2)}ms` 
                });
                
                const data = await response.json();
                const newStatus = data.status === 'healthy' ? 'healthy' : 'unhealthy';
                
                appState.setState({ apiStatus: newStatus });
                updateApiStatus();
                
                logger.info('API', `Backend status: ${newStatus}`, data);
                
            } catch (error) {
                logger.warn('API', 'Primary health check failed', { 
                    url: appState.backendUrl, 
                    error: error.message 
                });
                
                // If Docker service name fails, try localhost as fallback
                if (appState.backendUrl !== 'http://localhost:8000') {
                    logger.info('API', 'Attempting fallback to localhost');
                    
                    appState.setState({ backendUrl: 'http://localhost:8000' });
                    
                    try {
                        const fallbackStartTime = performance.now();
                        const fallbackResponse = await fetch(`${appState.backendUrl}/health`);
                        const fallbackResponseTime = performance.now() - fallbackStartTime;
                        
                        logger.info('API', `Fallback health check response`, { 
                            status: fallbackResponse.status, 
                            responseTime: `${fallbackResponseTime.toFixed(2)}ms` 
                        });
                        
                        const fallbackData = await fallbackResponse.json();
                        const fallbackStatus = fallbackData.status === 'healthy' ? 'healthy' : 'unhealthy';
                        
                        appState.setState({ apiStatus: fallbackStatus });
                        updateApiStatus();
                        
                        logger.info('API', `Fallback successful, backend status: ${fallbackStatus}`, fallbackData);
                        return;
                        
                    } catch (fallbackError) {
                        logger.error('API', 'Fallback health check also failed', fallbackError);
                    }
                }
                
                appState.setState({ apiStatus: 'unhealthy' });
                updateApiStatus();
                logger.error('API', 'All health checks failed, marking as unhealthy');
            }
        }

        function updateApiStatus() {
            logger.debug('UI', `Updating API status indicator`, { status: appState.apiStatus });
            
            if (appState.apiStatus === 'healthy') {
                domElements.apiStatusElement.innerHTML = `
                    <svg class="h-4 w-4 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm text-green-200">Online</span>
                `;
            } else {
                domElements.apiStatusElement.innerHTML = `
                    <svg class="h-4 w-4 text-red-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm text-red-200">Offline</span>
                `;
            }
        }

        async function sendMessage() {
            const message = domElements.messageInput.value.trim();
            
            logger.info('CHAT', 'Send message initiated', { 
                messageLength: message.length,
                isLoading: appState.isLoading,
                hasMessage: !!message
            });
            
            if (!message || appState.isLoading) {
                logger.warn('CHAT', 'Send message blocked', { 
                    reason: !message ? 'empty_message' : 'already_loading' 
                });
                return;
            }

            // Clear any previous errors
            appState.setError(null, 'send_message_start');

            // Add user message
            const userMessage = appState.addMessage({
                content: message,
                isUser: true
            });
            
            renderMessage(userMessage);
            domElements.messageInput.value = '';
            appState.setLoading(true, 'sending_user_message');

            const requestStartTime = performance.now();
            appState.setState({ lastRequestTime: requestStartTime });

            try {
                logger.info('API', 'Sending request to backend', { 
                    url: `${appState.backendUrl}/ask`,
                    questionLength: message.length 
                });

                const response = await fetch(`${appState.backendUrl}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: message,
                        max_response_length: 2000
                    })
                });

                const requestEndTime = performance.now();
                const requestDuration = requestEndTime - requestStartTime;

                logger.info('API', 'Response received from backend', { 
                    status: response.status,
                    statusText: response.statusText,
                    requestDuration: `${requestDuration.toFixed(2)}ms`
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                logger.info('API', 'Response data parsed successfully', {
                    answerLength: data.answer?.length || 0,
                    sourcesCount: data.sources_count,
                    toolsUsed: data.tools_used?.length || 0,
                    performanceMetrics: data.performance_metrics
                });
                
                // Update performance tracking
                appState.updatePerformanceMetrics(requestDuration);
                
                // Add bot response
                const botMessage = appState.addMessage({
                    content: data.answer,
                    isUser: false,
                    metadata: {
                        sources: data.sources_count,
                        processingTime: data.performance_metrics?.total_processing_time 
                            ? data.performance_metrics.total_processing_time.toFixed(2) + 's'
                            : undefined,
                        toolsUsed: data.tools_used,
                        sourceDetails: data.source_details
                    }
                });

                renderMessage(botMessage);
                logger.info('CHAT', 'Message exchange completed successfully');

            } catch (error) {
                const requestEndTime = performance.now();
                const requestDuration = requestEndTime - requestStartTime;
                
                logger.error('API', 'Request failed', { 
                    error: error.message,
                    requestDuration: `${requestDuration.toFixed(2)}ms`,
                    url: appState.backendUrl
                });

                appState.setError(error.message, 'api_request_failed');
                
                const errorMessage = appState.addMessage({
                    content: `Sorry, I encountered an error while processing your question. Please make sure the backend API is running at ${appState.backendUrl} and try again.\n\nError: ${error.message}`,
                    isUser: false,
                    metadata: { isError: true }
                });

                renderMessage(errorMessage);
                
            } finally {
                appState.setLoading(false, 'send_message_complete');
            }
        }

        function addMessage(content, isUser, metadata = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubbleClass = isUser 
                ? 'bg-blue-600 text-white' 
                : 'bg-white text-gray-800 shadow-md border';

            let metadataHtml = '';
            if (!isUser && (metadata.sources || metadata.processingTime)) {
                metadataHtml = `
                    <div class="flex items-center space-x-3">
                        ${metadata.sources ? `<span>📚 ${metadata.sources} sources</span>` : ''}
                        ${metadata.processingTime ? `
                            <span class="flex items-center space-x-1">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>${metadata.processingTime}</span>
                            </span>
                        ` : ''}
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="max-w-3xl rounded-lg p-4 ${bubbleClass}">
                    <div class="message-content">${content}</div>
                    <div class="flex items-center justify-between mt-2 text-xs opacity-70">
                        <span>${new Date().toLocaleTimeString()}</span>
                        ${metadataHtml}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function setLoading(loading) {
            isLoading = loading;
            sendButton.disabled = loading;
            messageInput.disabled = loading;

            if (loading) {
                showLoadingMessage();
            } else {
                hideLoadingMessage();
            }
        }

        function showLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-white text-gray-800 shadow-md border rounded-lg p-4 max-w-3xl">
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-blue-600 rounded-full loading-dots"></div>
                            <div class="w-2 h-2 bg-blue-600 rounded-full loading-dots"></div>
                            <div class="w-2 h-2 bg-blue-600 rounded-full loading-dots"></div>
                        </div>
                        <span>Searching through federal student loan knowledge base...</span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(loadingDiv);
            scrollToBottom();
        }

        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        function scrollToBottom() {
            setTimeout(() => {
                window.scrollTo(0, document.body.scrollHeight);
            }, 100);
        }
    </script>
</body>
</html>